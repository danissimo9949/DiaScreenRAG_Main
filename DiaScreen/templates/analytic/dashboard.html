{% extends 'base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/analytics-dashboard.css' %}">
{% endblock styles %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mb-5 analytics-header">
            <div>
                <h1 class="fw-semibold mb-2">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ –ø–∞—Ü—ñ—î–Ω—Ç–∞</h1>
                <p class="text-muted mb-0">
                    {{ patient.user.get_full_name|default:patient.user.username }},
                    {{ patient.age|default:'–≤—ñ–∫ –Ω–µ–≤—ñ–¥–æ–º–∏–π' }},
                    {{ patient.get_diabetes_type_display|default:'—Ç–∏–ø –¥—ñ–∞–±–µ—Ç—É –Ω–µ –≤–∫–∞–∑–∞–Ω–∏–π' }}
                </p>
            </div>
            <div class="d-flex flex-column align-items-end gap-2">
                <div class="d-flex gap-2 align-items-center">
                    <div class="btn-group" role="group">
                        <a href="?period=7" class="btn btn-sm {% if period == '7' %}btn-primary{% else %}btn-outline-primary{% endif %}">7 –¥–Ω—ñ–≤</a>
                        <a href="?period=30" class="btn btn-sm {% if period == '30' %}btn-primary{% else %}btn-outline-primary{% endif %}">30 –¥–Ω—ñ–≤</a>
                        <a href="?period=90" class="btn btn-sm {% if period == '90' %}btn-primary{% else %}btn-outline-primary{% endif %}">90 –¥–Ω—ñ–≤</a>
                        <a href="?period=365" class="btn btn-sm {% if period == '365' %}btn-primary{% else %}btn-outline-primary{% endif %}">–†—ñ–∫</a>
                    </div>
                    <a href="{% url 'analytic:patient_dashboard_pdf' patient.pk %}?period={{ period }}" class="btn btn-sm btn-success">
                        üìÑ –ï–∫—Å–ø–æ—Ä—Ç PDF
                    </a>
                    <button type="button" class="btn btn-sm btn-info" id="analyzeDataBtn">
                        ü§ñ –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –º–æ—ó –¥–∞–Ω—ñ
                    </button>
                </div>
                <span class="analytics-pill">
                    –ü–µ—Ä—ñ–æ–¥: {{ period_label }}
                </span>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">–ó–∞–º—ñ—Ä—ñ–≤ –≥–ª—é–∫–æ–∑–∏</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #2563eb, #60a5fa);">
                                G
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_glucose_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">–ü—Ä–∏–π–æ–º—ñ–≤ —ó–∂—ñ</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #db2777, #fb7185);">
                                F
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_food_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">–§—ñ–∑–∏—á–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #0f766e, #34d399);">
                                A
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_activity_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">–Ü–Ω&#8209;—î–∫—Ü—ñ–π —ñ–Ω—Å—É–ª—ñ–Ω—É</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #b45309, #fbbf24);">
                                I
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_insuline_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">–ì–ª—é–∫–æ–∑–Ω–∏—Ö –ø—Ä–æ—Ñ—ñ–ª—ñ–≤</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                                P
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_glycemic_profile_measurements }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">–î–∏–Ω–∞–º—ñ–∫–∞ —Ä—ñ–≤–Ω—è –≥–ª—é–∫–æ–∑–∏</h5>
                        <p class="text-muted small mb-0">–°–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –¥–µ–Ω—å ({{ period_label }})</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="glucoseTrendChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="glucoseTrend" hidden>
                            –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ –≥—Ä–∞—Ñ—ñ–∫–∞.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">–¢–∏–∂–Ω–µ–≤–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</h5>
                        <p class="text-muted small mb-0">–°–∫—ñ–ª—å–∫–∏ –∑–∞–ø–∏—Å—ñ–≤ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="weeklyActivityChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="weeklyActivity" hidden>
                            –î–∞–Ω–∏—Ö –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 7 –¥–Ω—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">–ì–ª—é–∫–æ–∑–∞ –∑–∞ —á–∞—Å–æ–º –¥–æ–±–∏</h5>
                        <p class="text-muted small mb-0">–°–µ—Ä–µ–¥–Ω—ñ —Ç–∞ –º–µ–¥—ñ–∞–Ω–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ –≥–æ–¥–∏–Ω–∞—Ö</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="glucoseByHourChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="glucoseByHour" hidden>
                            –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ –≥—Ä–∞—Ñ—ñ–∫–∞.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑–∞–º—ñ—Ä—ñ–≤ –≥–ª—é–∫–æ–∑–∏</h5>
                        <p class="text-muted small mb-0">–†–æ–∑–ø–æ–¥—ñ–ª –∑–∞ –æ–±—Ä–∞–Ω–∏–º–∏ —Å—Ü–µ–Ω–∞—Ä—ñ—è–º–∏</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="glucoseCategoryChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="glucoseCategory" hidden>
                            –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑ º—è–≤–ª—è—Ç—å—Å—è, —â–æ–π–Ω–æ –¥–æ–¥–∞—Å—Ç–µ –∫—ñ–ª—å–∫–∞ –∑–∞–º—ñ—Ä—ñ–≤.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {% if advanced_metrics %}
        <div class="row g-4 mb-5">
            <div class="col-lg-12">
                <div class="card analytics-card">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">–†–æ–∑—à–∏—Ä–µ–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏ –≥–ª—ñ–∫–µ–º—ñ—ó</h5>
                        <p class="text-muted small mb-0">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥</p>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-success mb-1">{{ advanced_metrics.tir_percent }}%</div>
                                    <div class="text-muted small">Time in Range</div>
                                    <div class="text-muted small">({{ patient.target_glucose_min|default:"4.0" }}-{{ patient.target_glucose_max|default:"9.0" }} –º–º–æ–ª—å/–ª)</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-warning mb-1">{{ advanced_metrics.hypo_percent }}%</div>
                                    <div class="text-muted small">–ì—ñ–ø–æ–≥–ª—ñ–∫–µ–º—ñ—è</div>
                                    <div class="text-muted small">(&lt; 3.9 –º–º–æ–ª—å/–ª)</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-danger mb-1">{{ advanced_metrics.hyper_percent }}%</div>
                                    <div class="text-muted small">–ì—ñ–ø–µ—Ä–≥–ª—ñ–∫–µ–º—ñ—è</div>
                                    <div class="text-muted small">(&gt; 10.0 –º–º–æ–ª—å/–ª)</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-primary mb-1">{{ advanced_metrics.sd }}</div>
                                    <div class="text-muted small">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è</div>
                                    <div class="text-muted small">CV: {{ advanced_metrics.cv }}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-4 mt-2">
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <span class="text-muted">–°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è:</span>
                                    <strong>{{ advanced_metrics.mean }} –º–º–æ–ª—å/–ª</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <span class="text-muted">GMI (–æ—Ü—ñ–Ω–∫–∞ HbA1c):</span>
                                    <strong>{{ advanced_metrics.gmi }}%</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <span class="text-muted">–ö—Ä–∏—Ç–∏—á–Ω–∞ –≥—ñ–ø–æ:</span>
                                    <strong class="text-danger">{{ advanced_metrics.critical_hypo_percent }}%</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0">–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∑–∞ {{ period_label|lower }}</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>–ó–∞–º—ñ—Ä—ñ–≤ –≥–ª—é–∫–æ–∑–∏</span>
                                <strong>{{ weekly_metrics.glucose }}</strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>–ü—Ä–∏–π–æ–º—ñ–≤ —ó–∂—ñ</span>
                                <strong>{{ weekly_metrics.food }}</strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>–§—ñ–∑–∏—á–Ω–∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</span>
                                <strong>{{ weekly_metrics.activity }}</strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>–Ü–Ω&#8209;—î–∫—Ü—ñ–π —ñ–Ω—Å—É–ª—ñ–Ω—É</span>
                                <strong>{{ weekly_metrics.insuline }}</strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0">–°–µ—Ä–µ–¥–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>–°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å –≥–ª—é–∫–æ–∑–∏</span>
                                <strong>
                                    {% if averages.glucose %}
                                        {{ averages.glucose|floatformat:1 }} –º–º–æ–ª—å/–ª
                                    {% else %}
                                        ‚Äî 
                                    {% endif %}
                                </strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>–°–µ—Ä–µ–¥–Ω—ñ–π HbA1c</span>
                                <strong>
                                    {% if averages.hba1c %}
                                        {{ averages.hba1c|floatformat:2 }} %
                                    {% else %}
                                        ‚Äî 
                                    {% endif %}
                                </strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card analytics-card">
            <div class="card-header bg-white border-0 pb-0">
                <h5 class="mb-0">–û—Å—Ç–∞–Ω–Ω—ñ –∑–∞–º—ñ—Ä–∏ –≥–ª—é–∫–æ–∑–∏</h5>
            </div>
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ß–∞—Å</th>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                            <th>–ó–Ω–∞—á–µ–Ω–Ω—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for measurement in recent_glucose_measurements %}
                        <tr>
                            <td>{{ measurement.date_of_measurement|date:'d.m.Y' }}</td>
                            <td>{{ measurement.time_of_measurement|time:'H:i' }}</td>
                            <td>{{ measurement.glucose_measurement_category|default:'‚Äî' }}</td>
                            <td>{{ measurement.glucose }} –º–º–æ–ª—å/–ª</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">–î–∞–Ω–∏—Ö –ø–æ–∫–∏ –Ω–µ–º–∞—î.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block scripts %}
{{ block.super }}
{{ chart_payload|json_script:"analytics-chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
    (function() {
        const dataElement = document.getElementById('analytics-chart-data');
        if (!dataElement) {
            return;
        }
        let payload = {};
        try {
            payload = JSON.parse(dataElement.textContent);
        } catch (error) {
            console.error('Failed to parse analytics payload', error);
            return;
        }

        const palette = {
            primary: '#2563eb',
            primarySoft: 'rgba(37, 99, 235, 0.2)',
            emerald: '#10b981',
            amber: '#f59e0b',
            rose: '#f43f5e',
            violet: '#8b5cf6',
            slate: '#1f2937'
        };

        const showEmptyMessage = (key, shouldShow) => {
            document
                .querySelectorAll(`[data-chart-empty="${key}"]`)
                .forEach((node) => {
                    node.hidden = !shouldShow;
                });
        };

        const glucoseTrendEl = document.getElementById('glucoseTrendChart');
        if (glucoseTrendEl && payload.glucoseTrend && payload.glucoseTrend.labels.length) {
            new Chart(glucoseTrendEl, {
                type: 'line',
                data: {
                    labels: payload.glucoseTrend.labels,
                    datasets: [{
                        label: '–°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è, –º–º–æ–ª—å/–ª',
                        data: payload.glucoseTrend.data,
                        fill: false,
                        tension: 0.35,
                        borderWidth: 3,
                        borderColor: palette.primary,
                        backgroundColor: palette.primarySoft,
                        pointBackgroundColor: palette.primary,
                        pointRadius: 4,
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                precision: 1
                            }
                        }
                    }
                }
            });
            showEmptyMessage('glucoseTrend', false);
        } else {
            showEmptyMessage('glucoseTrend', true);
        }

        const weeklyActivityEl = document.getElementById('weeklyActivityChart');
        if (weeklyActivityEl && payload.weeklyActivity && payload.weeklyActivity.data.some((value) => value > 0)) {
            new Chart(weeklyActivityEl, {
                type: 'bar',
                data: {
                    labels: payload.weeklyActivity.labels,
                    datasets: [{
                        label: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤',
                        data: payload.weeklyActivity.data,
                        backgroundColor: [
                            palette.primary,
                            palette.rose,
                            palette.emerald,
                            palette.amber
                        ],
                        borderRadius: 8,
                        maxBarThickness: 42
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            showEmptyMessage('weeklyActivity', false);
        } else {
            showEmptyMessage('weeklyActivity', true);
        }

        const glucoseCategoryEl = document.getElementById('glucoseCategoryChart');
        if (glucoseCategoryEl && payload.glucoseCategories && payload.glucoseCategories.data.length) {
            new Chart(glucoseCategoryEl, {
                type: 'doughnut',
                data: {
                    labels: payload.glucoseCategories.labels,
                    datasets: [{
                        data: payload.glucoseCategories.data,
                        backgroundColor: [
                            palette.primary,
                            palette.rose,
                            palette.emerald,
                            palette.amber,
                            palette.violet,
                            palette.slate
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            showEmptyMessage('glucoseCategory', false);
        } else {
            showEmptyMessage('glucoseCategory', true);
        }

        const glucoseByHourEl = document.getElementById('glucoseByHourChart');
        if (glucoseByHourEl && payload.glucoseByHour && payload.glucoseByHour.labels.length) {
            new Chart(glucoseByHourEl, {
                type: 'line',
                data: {
                    labels: payload.glucoseByHour.labels,
                    datasets: [
                        {
                            label: '–°–µ—Ä–µ–¥–Ω—î –∑–Ω–∞—á–µ–Ω–Ω—è',
                            data: payload.glucoseByHour.means,
                            borderColor: palette.primary,
                            backgroundColor: palette.primarySoft,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                        },
                        {
                            label: '–ú–µ–¥—ñ–∞–Ω–∞',
                            data: payload.glucoseByHour.medians,
                            borderColor: palette.emerald,
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                precision: 1
                            },
                            title: {
                                display: true,
                                text: '–ì–ª—é–∫–æ–∑–∞ (–º–º–æ–ª—å/–ª)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '–ß–∞—Å –¥–æ–±–∏'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            showEmptyMessage('glucoseByHour', false);
        } else {
            showEmptyMessage('glucoseByHour', true);
        }
    })();
</script>

<div class="modal fade" id="aiAnalysisModal" tabindex="-1" aria-labelledby="aiAnalysisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aiAnalysisModalLabel">
                    ü§ñ AI –ê–Ω–∞–ª—ñ–∑ –≤–∞—à–∏—Ö –¥–∞–Ω–∏—Ö
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="aiAnalysisLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                    </div>
                    <p class="mt-3 text-muted">AI –∞–Ω–∞–ª—ñ–∑—É—î –≤–∞—à—ñ –¥–∞–Ω—ñ...</p>
                </div>
                <div id="aiAnalysisContent" style="display: none;">
                    <div class="alert alert-info">
                        <strong>–ü–µ—Ä—ñ–æ–¥ –∞–Ω–∞–ª—ñ–∑—É:</strong> {{ period_label }}
                    </div>
                    <div id="aiAnalysisText" class="p-3 bg-light rounded" style="white-space: pre-wrap; line-height: 1.6;"></div>
                </div>
                <div id="aiAnalysisError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                <a href="{% url 'chat' %}" class="btn btn-primary">–ó–∞–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è –≤ —á–∞—Ç—ñ</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyzeBtn = document.getElementById('analyzeDataBtn');
    if (!analyzeBtn) {
        console.error('–ö–Ω–æ–ø–∫–∞ analyzeDataBtn –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
        return;
    }
    
    const modalEl = document.getElementById('aiAnalysisModal');
    if (!modalEl) {
        console.error('–ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ aiAnalysisModal –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
        return;
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ Bootstrap –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π');
        return;
    }
    
    const modal = new bootstrap.Modal(modalEl);
    const loadingEl = document.getElementById('aiAnalysisLoading');
    const contentEl = document.getElementById('aiAnalysisContent');
    const errorEl = document.getElementById('aiAnalysisError');
    const analysisTextEl = document.getElementById('aiAnalysisText');
    
    analyzeBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        console.log('–ö–Ω–æ–ø–∫–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞');
        
        modal.show();
        
        loadingEl.style.display = 'block';
        contentEl.style.display = 'none';
        errorEl.style.display = 'none';
        
        try {
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            const csrftoken = getCookie('csrftoken') || document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            
            const url = '{% url "analytic:analyze_data" patient.pk %}';
            console.log('–í—ñ–¥–ø—Ä–∞–≤–ª—è—é –∑–∞–ø–∏—Ç –Ω–∞:', url);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    period: '{{ period }}'
                })
            });
            
            console.log('–û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:', response.status);
            const data = await response.json();
            console.log('–î–∞–Ω—ñ:', data);
            
            if (data.success) {
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                analysisTextEl.textContent = data.analysis;
            } else {
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                errorEl.textContent = data.error || '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª—ñ–∑—ñ –¥–∞–Ω–∏—Ö';
            }
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞:', error);
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            errorEl.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.';
        }
    });
    
    console.log('–°–∫—Ä–∏–ø—Ç AI –∞–Ω–∞–ª—ñ–∑—É —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
});
</script>
{% endblock scripts %}

