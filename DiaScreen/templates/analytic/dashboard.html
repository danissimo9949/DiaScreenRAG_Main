{% extends 'base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/analytics-dashboard.css' %}">
{% endblock styles %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mb-5 analytics-header">
            <div>
                <h1 class="fw-semibold mb-2">Аналітика пацієнта</h1>
                <p class="text-muted mb-0">
                    {{ patient.user.get_full_name|default:patient.user.username }},
                    {{ patient.age|default:'вік невідомий' }},
                    {{ patient.get_diabetes_type_display|default:'тип діабету не вказаний' }}
                </p>
            </div>
            <div class="d-flex flex-column align-items-end gap-2">
                <div class="btn-group" role="group">
                    <a href="?period=7" class="btn btn-sm {% if period == '7' %}btn-primary{% else %}btn-outline-primary{% endif %}">7 днів</a>
                    <a href="?period=30" class="btn btn-sm {% if period == '30' %}btn-primary{% else %}btn-outline-primary{% endif %}">30 днів</a>
                    <a href="?period=90" class="btn btn-sm {% if period == '90' %}btn-primary{% else %}btn-outline-primary{% endif %}">90 днів</a>
                    <a href="?period=365" class="btn btn-sm {% if period == '365' %}btn-primary{% else %}btn-outline-primary{% endif %}">Рік</a>
                </div>
                <span class="analytics-pill">
                    Період: {{ period_label }}
                </span>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">Замірів глюкози</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #2563eb, #60a5fa);">
                                G
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_glucose_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">Прийомів їжі</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #db2777, #fb7185);">
                                F
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_food_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">Фізичних активностей</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #0f766e, #34d399);">
                                A
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_activity_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">Ін&#8209;єкцій інсуліну</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #b45309, #fbbf24);">
                                I
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_insuline_measurements }}</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card analytics-card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <p class="analytics-card__badge mb-0">Глюкозних профілів</p>
                            <span class="analytics-card__icon" style="background: linear-gradient(135deg, #7c3aed, #a855f7);">
                                P
                            </span>
                        </div>
                        <div class="analytics-card__value">{{ total_glycemic_profile_measurements }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">Динаміка рівня глюкози</h5>
                        <p class="text-muted small mb-0">Середні значення за день ({{ period_label }})</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="glucoseTrendChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="glucoseTrend" hidden>
                            Недостатньо даних для побудови графіка.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">Тижнева активність</h5>
                        <p class="text-muted small mb-0">Скільки записів за останні 7 днів</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="weeklyActivityChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="weeklyActivity" hidden>
                            Даних за останні 7 днів поки немає.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">Глюкоза за часом доби</h5>
                        <p class="text-muted small mb-0">Середні та медіанні значення по годинах</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="glucoseByHourChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="glucoseByHour" hidden>
                            Недостатньо даних для побудови графіка.
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">Категорії замірів глюкози</h5>
                        <p class="text-muted small mb-0">Розподіл за обраними сценаріями</p>
                    </div>
                    <div class="card-body analytics-chart">
                        <canvas id="glucoseCategoryChart"></canvas>
                        <p class="text-muted text-center small" data-chart-empty="glucoseCategory" hidden>
                            Категорії зʼявляться, щойно додасте кілька замірів.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        {% if advanced_metrics %}
        <div class="row g-4 mb-5">
            <div class="col-lg-12">
                <div class="card analytics-card">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0 text-primary-emphasis">Розширені метрики глікемії</h5>
                        <p class="text-muted small mb-0">Статистика за обраний період</p>
                    </div>
                    <div class="card-body">
                        <div class="row g-4">
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-success mb-1">{{ advanced_metrics.tir_percent }}%</div>
                                    <div class="text-muted small">Time in Range</div>
                                    <div class="text-muted small">({{ patient.target_glucose_min|default:"4.0" }}-{{ patient.target_glucose_max|default:"9.0" }} ммоль/л)</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-warning mb-1">{{ advanced_metrics.hypo_percent }}%</div>
                                    <div class="text-muted small">Гіпоглікемія</div>
                                    <div class="text-muted small">(&lt; 3.9 ммоль/л)</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-danger mb-1">{{ advanced_metrics.hyper_percent }}%</div>
                                    <div class="text-muted small">Гіперглікемія</div>
                                    <div class="text-muted small">(&gt; 10.0 ммоль/л)</div>
                                </div>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="fs-4 fw-bold text-primary mb-1">{{ advanced_metrics.sd }}</div>
                                    <div class="text-muted small">Стандартне відхилення</div>
                                    <div class="text-muted small">CV: {{ advanced_metrics.cv }}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-4 mt-2">
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <span class="text-muted">Середнє значення:</span>
                                    <strong>{{ advanced_metrics.mean }} ммоль/л</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <span class="text-muted">GMI (оцінка HbA1c):</span>
                                    <strong>{{ advanced_metrics.gmi }}%</strong>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                    <span class="text-muted">Критична гіпо:</span>
                                    <strong class="text-danger">{{ advanced_metrics.critical_hypo_percent }}%</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0">Активність за {{ period_label|lower }}</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>Замірів глюкози</span>
                                <strong>{{ weekly_metrics.glucose }}</strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>Прийомів їжі</span>
                                <strong>{{ weekly_metrics.food }}</strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>Фізичних активностей</span>
                                <strong>{{ weekly_metrics.activity }}</strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>Ін&#8209;єкцій інсуліну</span>
                                <strong>{{ weekly_metrics.insuline }}</strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card analytics-card h-100">
                    <div class="card-header bg-white border-0 pb-0">
                        <h5 class="mb-0">Середні показники</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>Середній рівень глюкози</span>
                                <strong>
                                    {% if averages.glucose %}
                                        {{ averages.glucose|floatformat:1 }} ммоль/л
                                    {% else %}
                                        — 
                                    {% endif %}
                                </strong>
                            </li>
                            <li class="list-group-item px-0 d-flex justify-content-between">
                                <span>Середній HbA1c</span>
                                <strong>
                                    {% if averages.hba1c %}
                                        {{ averages.hba1c|floatformat:2 }} %
                                    {% else %}
                                        — 
                                    {% endif %}
                                </strong>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card analytics-card">
            <div class="card-header bg-white border-0 pb-0">
                <h5 class="mb-0">Останні заміри глюкози</h5>
            </div>
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Час</th>
                            <th>Категорія</th>
                            <th>Значення</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for measurement in recent_glucose_measurements %}
                        <tr>
                            <td>{{ measurement.date_of_measurement|date:'d.m.Y' }}</td>
                            <td>{{ measurement.time_of_measurement|time:'H:i' }}</td>
                            <td>{{ measurement.glucose_measurement_category|default:'—' }}</td>
                            <td>{{ measurement.glucose }} ммоль/л</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Даних поки немає.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block scripts %}
{{ block.super }}
{{ chart_payload|json_script:"analytics-chart-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
    (function() {
        const dataElement = document.getElementById('analytics-chart-data');
        if (!dataElement) {
            return;
        }
        let payload = {};
        try {
            payload = JSON.parse(dataElement.textContent);
        } catch (error) {
            console.error('Failed to parse analytics payload', error);
            return;
        }

        const palette = {
            primary: '#2563eb',
            primarySoft: 'rgba(37, 99, 235, 0.2)',
            emerald: '#10b981',
            amber: '#f59e0b',
            rose: '#f43f5e',
            violet: '#8b5cf6',
            slate: '#1f2937'
        };

        const showEmptyMessage = (key, shouldShow) => {
            document
                .querySelectorAll(`[data-chart-empty="${key}"]`)
                .forEach((node) => {
                    node.hidden = !shouldShow;
                });
        };

        const glucoseTrendEl = document.getElementById('glucoseTrendChart');
        if (glucoseTrendEl && payload.glucoseTrend && payload.glucoseTrend.labels.length) {
            new Chart(glucoseTrendEl, {
                type: 'line',
                data: {
                    labels: payload.glucoseTrend.labels,
                    datasets: [{
                        label: 'Середнє значення, ммоль/л',
                        data: payload.glucoseTrend.data,
                        fill: false,
                        tension: 0.35,
                        borderWidth: 3,
                        borderColor: palette.primary,
                        backgroundColor: palette.primarySoft,
                        pointBackgroundColor: palette.primary,
                        pointRadius: 4,
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                precision: 1
                            }
                        }
                    }
                }
            });
            showEmptyMessage('glucoseTrend', false);
        } else {
            showEmptyMessage('glucoseTrend', true);
        }

        const weeklyActivityEl = document.getElementById('weeklyActivityChart');
        if (weeklyActivityEl && payload.weeklyActivity && payload.weeklyActivity.data.some((value) => value > 0)) {
            new Chart(weeklyActivityEl, {
                type: 'bar',
                data: {
                    labels: payload.weeklyActivity.labels,
                    datasets: [{
                        label: 'Кількість записів',
                        data: payload.weeklyActivity.data,
                        backgroundColor: [
                            palette.primary,
                            palette.rose,
                            palette.emerald,
                            palette.amber
                        ],
                        borderRadius: 8,
                        maxBarThickness: 42
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            showEmptyMessage('weeklyActivity', false);
        } else {
            showEmptyMessage('weeklyActivity', true);
        }

        const glucoseCategoryEl = document.getElementById('glucoseCategoryChart');
        if (glucoseCategoryEl && payload.glucoseCategories && payload.glucoseCategories.data.length) {
            new Chart(glucoseCategoryEl, {
                type: 'doughnut',
                data: {
                    labels: payload.glucoseCategories.labels,
                    datasets: [{
                        data: payload.glucoseCategories.data,
                        backgroundColor: [
                            palette.primary,
                            palette.rose,
                            palette.emerald,
                            palette.amber,
                            palette.violet,
                            palette.slate
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            showEmptyMessage('glucoseCategory', false);
        } else {
            showEmptyMessage('glucoseCategory', true);
        }

        const glucoseByHourEl = document.getElementById('glucoseByHourChart');
        if (glucoseByHourEl && payload.glucoseByHour && payload.glucoseByHour.labels.length) {
            new Chart(glucoseByHourEl, {
                type: 'line',
                data: {
                    labels: payload.glucoseByHour.labels,
                    datasets: [
                        {
                            label: 'Середнє значення',
                            data: payload.glucoseByHour.means,
                            borderColor: palette.primary,
                            backgroundColor: palette.primarySoft,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                        },
                        {
                            label: 'Медіана',
                            data: payload.glucoseByHour.medians,
                            borderColor: palette.emerald,
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 12, right: 16, bottom: 12, left: 16 }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                precision: 1
                            },
                            title: {
                                display: true,
                                text: 'Глюкоза (ммоль/л)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Час доби'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            showEmptyMessage('glucoseByHour', false);
        } else {
            showEmptyMessage('glucoseByHour', true);
        }
    })();
</script>
{% endblock scripts %}

