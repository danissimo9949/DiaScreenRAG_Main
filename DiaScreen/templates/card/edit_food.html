{% extends "base.html" %}
{% block title %}Редагування прийому їжі{% endblock %}
{% block content %}
<div class="container py-4">
  <h4 class="mb-3">Редагування прийому їжі</h4>
  <form method="post" class="row g-3">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="col-md-6">{{ form.category.label_tag }} {{ form.category }}</div>
    <div class="col-md-3">{{ form.date_of_measurement.label_tag }} {{ form.date_of_measurement }}</div>
    <div class="col-md-3">{{ form.time_of_eating.label_tag }} {{ form.time_of_eating }}</div>
    <div class="col-md-4">{{ form.insuline_dose_before.label_tag }} {{ form.insuline_dose_before }}</div>

    <div class="col-12" data-portions-area>
      <h5 class="mt-3">Порції</h5>
      <div class="row g-3 portion-formset" data-formset>
        {{ portion_formset.management_form }}
        {% for f in portion_formset %}
          <div class="col-12 col-lg-6" data-portion-item>
            <div class="border rounded-3 p-3 bg-light h-100 position-relative">
              {{ f.non_field_errors }}
              {% if f.id %}{{ f.id }}{% endif %}
              {% if f.DELETE %}{{ f.DELETE }}{% endif %}
              <div class="mb-2">{{ f.food_name.label_tag }} {{ f.food_name }}</div>
              <div class="row g-2">
                <div class="col-sm-6">{{ f.carbohydrates.label_tag }} {{ f.carbohydrates }}</div>
                <div class="col-sm-6">{{ f.grams.label_tag }} {{ f.grams }}</div>
              </div>
              {% if f.DELETE %}
                <button type="button" class="btn btn-outline-danger btn-sm mt-2" data-delete-portion>Видалити порцію</button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="d-none" data-empty-form>
        <div class="col-12 col-lg-6" data-portion-item>
          <div class="border rounded-3 p-3 bg-light h-100 position-relative">
            {{ portion_formset.empty_form.id }}
            {{ portion_formset.empty_form.DELETE }}
            <div class="mb-2">{{ portion_formset.empty_form.food_name.label_tag }} {{ portion_formset.empty_form.food_name }}</div>
            <div class="row g-2">
              <div class="col-sm-6">{{ portion_formset.empty_form.carbohydrates.label_tag }} {{ portion_formset.empty_form.carbohydrates }}</div>
              <div class="col-sm-6">{{ portion_formset.empty_form.grams.label_tag }} {{ portion_formset.empty_form.grams }}</div>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm mt-2" data-delete-portion>Видалити порцію</button>
          </div>
        </div>
      </div>
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-3">
        <button type="button" class="btn btn-outline-primary" data-add-portion>+ Додати порцію</button>
        <div class="d-flex gap-2">
          <button class="btn btn-primary">Зберегти</button>
          <a class="btn btn-outline-secondary" href="{% url 'card:patient_card' %}">Повернутися до картки</a>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('[data-portions-area]').forEach(function (area) {
    const addBtn = area.querySelector('[data-add-portion]');
    const formsetContainer = area.querySelector('[data-formset]');
    const emptyTemplate = area.querySelector('[data-empty-form]');
    const totalFormsInput = area.querySelector('input[id$="-TOTAL_FORMS"]');

    if (!addBtn || !formsetContainer || !emptyTemplate || !totalFormsInput) {
      return;
    }

    // Додавання нової порції
    addBtn.addEventListener('click', function () {
      const currentCount = parseInt(totalFormsInput.value || '0', 10);
      let formHtml = emptyTemplate.innerHTML.replace(/__prefix__/g, currentCount);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = formHtml.trim();
      const newCol = wrapper.firstElementChild;
      if (newCol) {
        formsetContainer.appendChild(newCol);
        totalFormsInput.value = currentCount + 1;
      }
    });

    // Видалення порції
    formsetContainer.addEventListener('click', function (e) {
      if (e.target && e.target.hasAttribute('data-delete-portion')) {
        const portionItem = e.target.closest('[data-portion-item]');
        if (portionItem) {
          const deleteCheckbox = portionItem.querySelector('input[type="checkbox"][id$="-DELETE"]');
          if (deleteCheckbox) {
            deleteCheckbox.checked = true;
            portionItem.style.opacity = '0.5';
            portionItem.style.pointerEvents = 'none';
            e.target.textContent = 'Видалено';
            e.target.disabled = true;
          } else {
            portionItem.remove();
            const currentCount = parseInt(totalFormsInput.value || '0', 10);
            totalFormsInput.value = Math.max(0, currentCount - 1);
          }
        }
      }
    });
  });
});
</script>
{% endblock %}


